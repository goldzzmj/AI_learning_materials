# ms-swift 架构图详解

## 1. 整体架构层次图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户接口层 (CLI)                                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐      │
│  │swift sft │ │swift pt  │ │swift rlhf│ │swift infer│ │swift export│ │swift deploy  │      │
│  │  微调    │ │  预训练  │ │ RLHF训练 │ │   推理   │ │   导出    │ │   部署      │      │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └─────┬────┘ └──────┬───────┘      │
└───────┼────────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────┘
        │            │            │            │             │             │
        └────────────┴────────────┴────────────┴─────────────┴─────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              CLI路由层 (swift/cli/main.py)                               │
│                                                                                         │
│   ROUTE_MAPPING = {                                                                     │
│       'sft': 'swift.cli.sft',                                                           │
│       'pt': 'swift.cli.pt',                                                             │
│       'rlhf': 'swift.cli.rlhf',                                                         │
│       'infer': 'swift.cli.infer',                                                       │
│       ...                                                                               │
│   }                                                                                     │
└─────────────────────────────────┬───────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Pipeline层 (swift/pipelines/)                               │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐         │
│  │  train/sft.py  │  │ train/rlhf.py  │  │  infer/infer.py│  │ export/export.py│         │
│  │   SFT训练流程   │  │  RLHF训练流程   │  │   推理流程      │  │   导出流程       │         │
│  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘         │
└───────────┼───────────────────┼───────────────────┼───────────────────┼─────────────────┘
            │                   │                   │                   │
            └───────────────────┴─────────┬─────────┴───────────────────┘
                                          │
            ┌─────────────────────────────┼─────────────────────────────┐
            │                             │                             │
            ▼                             ▼                             ▼
┌───────────────────────┐    ┌───────────────────────┐    ┌───────────────────────┐
│    Trainer层          │    │    Template层         │    │    Model层            │
│  (swift/trainers/)    │    │  (swift/template/)    │    │  (swift/model/)       │
│                       │    │                       │    │                       │
│ ┌─────────────────┐   │    │ ┌─────────────────┐   │    │ ┌─────────────────┐   │
│ │Seq2SeqTrainer   │   │    │ │Template (base)  │   │    │ │ModelMeta        │   │
│ │  - SFT训练器     │   │    │ │  - 模板基类      │   │    │ │  - 模型元数据    │   │
│ └─────────────────┘   │    │ └─────────────────┘   │    │ └─────────────────┘   │
│ ┌─────────────────┐   │    │ ┌─────────────────┐   │    │ ┌─────────────────┐   │
│ │SwiftMixin       │   │    │ │TemplateMeta     │   │    │ │ModelArch        │   │
│ │  - 核心功能混合  │   │    │ │  - 模板元数据    │   │    │ │  - 模型架构      │   │
│ └─────────────────┘   │    │ └─────────────────┘   │    │ └─────────────────┘   │
│ ┌─────────────────┐   │    │ ┌─────────────────┐   │    │ ┌─────────────────┐   │
│ │EmbeddingTrainer │   │    │ │30+ Templates    │   │    │ │register.py      │   │
│ │  - Embedding训练 │   │    │ │  - 30+模型模板   │   │    │ │  - 模型注册器    │   │
│ └─────────────────┘   │    │ └─────────────────┘   │    │ └─────────────────┘   │
└───────────┬───────────┘    └───────────┬───────────┘    └───────────┬───────────┘
            │                            │                            │
            └────────────────────────────┼────────────────────────────┘
                                         │
            ┌────────────────────────────┼────────────────────────────┐
            │                            │                            │
            ▼                            ▼                            ▼
┌───────────────────────┐    ┌───────────────────────┐    ┌───────────────────────┐
│    Tuner层            │    │    Dataset层          │    │    Infer Engine层     │
│  (swift/tuners/)      │    │  (swift/dataset/)     │    │  (swift/infer_engine/)│
│                       │    │                       │    │                       │
│ ┌─────────────────┐   │    │ ┌─────────────────┐   │    │ ┌─────────────────┐   │
│ │LoRA/QLoRA       │   │    │ │load_dataset     │   │    │ │InferEngine      │   │
│ │  - 低秩适应      │   │    │ │  - 数据加载      │   │    │ │  - 推理引擎基类  │   │
│ └─────────────────┘   │    │ └─────────────────┘   │    │ └─────────────────┘   │
│ ┌─────────────────┐   │    │ ┌─────────────────┐   │    │ ┌─────────────────┐   │
│ │Adapter          │   │    │ │EncodePreprocessor│  │    │ │TransformersEngine│  │
│ │  - 适配器微调    │   │    │ │  - 编码预处理    │   │    │ │  - HF推理引擎    │   │
│ └─────────────────┘   │    │ └─────────────────┘   │    │ └─────────────────┘   │
│ ┌─────────────────┐   │    │                       │    │ ┌─────────────────┐   │
│ │Prompt Tuning    │   │    │                       │    │ │VllmEngine       │   │
│ │  - 提示微调      │   │    │                       │    │ │  - vLLM推理      │   │
│ └─────────────────┘   │    │                       │    │ └─────────────────┘   │
│ ┌─────────────────┐   │    │                       │    │ ┌─────────────────┐   │
│ │NEFTune          │   │    │                       │    │ │SglangEngine     │   │
│ │  - 噪声嵌入微调  │   │    │                       │    │ │  - SGLang推理    │   │
│ └─────────────────┘   │    │                       │    │ └─────────────────┘   │
└───────────────────────┘    └───────────────────────┘    └───────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              后端层 (Backend Layer)                                      │
│                                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  PyTorch     │  │Transformers  │  │  DeepSpeed   │  │  Megatron    │  │   vLLM   │  │
│  │  深度学习框架 │  │  模型库      │  │  分布式训练  │  │  大规模训练  │  │ 推理引擎  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. RLHF训练架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   RLHF Training Pipeline                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Phase 1: SFT (Supervised Fine-Tuning)                                                │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │  Base Model ──────▶ SFT Training ──────▶ SFT Model (Reference)         │          │
│   │  (Qwen/Llama)       (swift sft)          (π_ref)                       │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
│                                          │                                              │
│                                          ▼                                              │
│   Phase 2: Reward Model Training                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │  Preference Data ──────▶ Reward Trainer ──────▶ Reward Model            │          │
│   │  (chosen/rejected)      (reward_trainer.py)    (r_φ)                   │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
│                                          │                                              │
│                                          ▼                                              │
│   Phase 3: RL Training                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                                                                         │          │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │          │
│   │   │ SFT Model   │───▶│   Rollout   │───▶│  vLLM Engine│                │          │
│   │   │ (π_old)     │    │ (rollout/)  │    │ (Generation)│                │          │
│   │   └─────────────┘    └─────────────┘    └──────┬──────┘                │          │
│   │                                                │                       │          │
│   │                                                ▼                       │          │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │          │
│   │   │ Reward Model│◀───│ Reward Calc │◀───│ Completions │                │          │
│   │   │ (r_φ)       │    │ (rewards/)  │    │  (responses)│                │          │
│   │   └─────────────┘    └─────────────┘    └─────────────┘                │          │
│   │                                                │                       │          │
│   │                                                ▼                       │          │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │          │
│   │   │ PPO/GRPO    │◀───│  Advantage  │◀───│   KL Div    │                │          │
│   │   │ Trainer     │    │   Compute   │    │   Penalty   │                │          │
│   │   │(rlhf_trainers)│   │             │    │             │                │          │
│   │   └─────────────┘    └─────────────┘    └─────────────┘                │          │
│   │                                                │                       │          │
│   │                                                ▼                       │          │
│   │   ┌─────────────────────────────────────────────────────────┐          │          │
│   │   │              Policy Update (π_new)                      │          │          │
│   │   └─────────────────────────────────────────────────────────┘          │          │
│   │                                                                         │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    训练数据流                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Raw Dataset        Template Processing        Encoding        Batching                │
│                                                                                         │
│   ┌─────────┐         ┌─────────────┐         ┌─────────┐      ┌─────────┐             │
│   │ JSON/   │         │  System     │         │ Tokenize│      │  Batch  │             │
│   │ JSONL   │────────▶│  User       │────────▶│  + Pad  │─────▶│  Collate│             │
│   │ Parquet │         │  Assistant  │         │  Trunc  │      │         │             │
│   └─────────┘         └─────────────┘         └─────────┘      └────┬────┘             │
│                                                                     │                   │
│                                                                     ▼                   │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              Model Forward                                       │  │
│   │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐  │  │
│   │  │   Input     │───▶│   Model     │───▶│   Loss      │───▶│   Backward      │  │  │
│   │  │   IDs       │    │   (LLM)     │    │   Compute   │    │   + Optimize    │  │  │
│   │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                     │                   │
│                                                                     ▼                   │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              Checkpoint Saving                                   │  │
│   │  - Model weights (LoRA/full)  - Optimizer states  - Training config             │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    模块依赖关系                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   cli/                                                                                  │
│   │                                                                                     │
│   ├──▶ pipelines/                                                                      │
│   │      │                                                                              │
│   │      ├──▶ trainers/ ──────▶ tuner_plugin/                                          │
│   │      │       │                    │                                                 │
│   │      │       │                    └──▶ tuners/                                     │
│   │      │       │                         │                                            │
│   │      │       │                         ├──▶ lora.py (LoRA/QLoRA/DoRA)              │
│   │      │       │                         ├──▶ adapter.py                            │
│   │      │       │                         └──▶ prompt.py                             │
│   │      │       │                                                                      │
│   │      │       ├──▶ template/ ────▶ templates/ (30+ model templates)                 │
│   │      │       │                                                                      │
│   │      │       ├──▶ model/ ───────▶ models/ (600+ LLMs, 300+ VLMs)                   │
│   │      │       │                                                                      │
│   │      │       └──▶ dataset/                                                        │
│   │      │                                                                              │
│   │      ├──▶ rlhf_trainers/ ────▶ rollout/ ────▶ rewards/                            │
│   │      │       │                                                                      │
│   │      │       ├──▶ dpo_trainer.py                                                   │
│   │      │       ├──▶ ppo_trainer.py                                                   │
│   │      │       ├──▶ grpo_trainer.py                                                  │
│   │      │       └──▶ ... (7+ RLHF trainers)                                           │
│   │      │                                                                              │
│   │      └──▶ infer_engine/                                                            │
│   │              │                                                                      │
│   │              ├──▶ TransformersEngine                                               │
│   │              ├──▶ VllmEngine                                                       │
│   │              ├──▶ SglangEngine                                                     │
│   │              └──▶ LmdeployEngine                                                   │
│   │                                                                                     │
│   └──▶ arguments/ ────▶ config/                                                        │
│                                                                                         │
│   utils/ (shared utilities)                                                            │
│   │                                                                                     │
│   ├──▶ Used by all modules                                                             │
│   └──▶ import_utils.py (lazy loading)                                                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 类继承关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    核心类继承关系                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Trainer (HuggingFace)                                                                 │
│   │                                                                                     │
│   └──▶ SwiftMixin (swift/trainers/mixin.py)                                            │
│          │                                                                              │
│          ├──▶ Seq2SeqTrainer (swift/trainers/seq2seq_trainer.py)                       │
│          │       │                                                                      │
│          │       └──▶ Used for: SFT, Pretrain, DPO, ORPO, CPO                          │
│          │                                                                              │
│          ├──▶ EmbeddingTrainer (swift/trainers/embedding_trainer.py)                   │
│          │       │                                                                      │
│          │       └──▶ Used for: Embedding model training                               │
│          │                                                                              │
│          └──▶ RerankerTrainer (swift/trainers/reranker_trainer.py)                     │
│                  │                                                                      │
│                  └──▶ Used for: Reranker model training                                │
│                                                                                         │
│   RLHFMixin (swift/rlhf_trainers/rlhf_mixin.py)                                        │
│   │                                                                                     │
│   ├──▶ DPOTrainer (swift/rlhf_trainers/dpo_trainer.py)                                 │
│   │       └──▶ Direct Preference Optimization                                          │
│   │                                                                                     │
│   ├──▶ PPOTrainer (swift/rlhf_trainers/ppo_trainer.py)                                 │
│   │       └──▶ Proximal Policy Optimization                                            │
│   │                                                                                     │
│   ├──▶ GRPOTrainer (swift/rlhf_trainers/grpo_trainer.py)                               │
│   │       └──▶ Group Relative Policy Optimization                                      │
│   │                                                                                     │
│   ├──▶ KTOTrainer (swift/rlhf_trainers/kto_trainer.py)                                 │
│   │       └──▶ Kahneman-Tversky Optimization                                           │
│   │                                                                                     │
│   ├──▶ ORPOTrainer (swift/rlhf_trainers/orpo_trainer.py)                               │
│   │       └──▶ Odds Ratio Preference Optimization                                      │
│   │                                                                                     │
│   └──▶ ... (7+ RLHF trainers)                                                          │
│                                                                                         │
│   Template (swift/template/base.py)                                                    │
│   │                                                                                     │
│   ├──▶ QwenTemplate (swift/template/templates/qwen.py)                                 │
│   ├──▶ LlamaTemplate (swift/template/templates/llama.py)                               │
│   ├──▶ DeepSeekTemplate (swift/template/templates/deepseek.py)                         │
│   └──▶ ... (30+ model templates)                                                       │
│                                                                                         │
│   Tuner (swift/tuners/base.py)                                                         │
│   │                                                                                     │
│   ├──▶ LoRA (swift/tuners/lora.py)                                                     │
│   ├──▶ Adapter (swift/tuners/adapter.py)                                               │
│   ├──▶ PromptTuning (swift/tuners/prompt.py)                                           │
│   └──▶ ... (10+ tuning methods)                                                        │
│                                                                                         │
│   InferEngine (swift/infer_engine/base.py)                                             │
│   │                                                                                     │
│   ├──▶ TransformersEngine                                                              │
│   ├──▶ VllmEngine                                                                      │
│   ├──▶ SglangEngine                                                                    │
│   └──▶ LmdeployEngine                                                                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 配置文件结构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    配置层次结构                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   BaseArguments (swift/arguments/base_args.py)                                         │
│   │                                                                                     │
│   ├──▶ PretrainArguments (swift/arguments/train_args.py)                               │
│   │       └──▶ 预训练/持续预训练参数                                                    │
│   │                                                                                     │
│   ├──▶ SftArguments (swift/arguments/train_args.py)                                    │
│   │       └──▶ 有监督微调参数                                                           │
│   │                                                                                     │
│   ├──▶ RLHFArguments (swift/arguments/rlhf_args.py)                                    │
│   │       └──▶ RLHF训练参数 (DPO, PPO, GRPO, etc.)                                     │
│   │                                                                                     │
│   ├──▶ InferArguments (swift/arguments/infer_args.py)                                  │
│   │       └──▶ 推理参数                                                                 │
│   │                                                                                     │
│   ├──▶ ExportArguments (swift/arguments/export_args.py)                                │
│   │       └──▶ 模型导出参数                                                             │
│   │                                                                                     │
│   ├──▶ EvalArguments (swift/arguments/eval_args.py)                                    │
│   │       └──▶ 评估参数                                                                 │
│   │                                                                                     │
│   ├──▶ DeployArguments (swift/arguments/deploy_args.py)                                │
│   │       └──▶ 部署参数                                                                 │
│   │                                                                                     │
│   └──▶ AppArguments (swift/arguments/app_args.py)                                      │
│           └──▶ 应用参数                                                                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```
